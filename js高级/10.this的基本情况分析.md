**this**

- 事件绑定
- 函数执行[普通函数执行、成员访问、匿名函数、回调函数... ]
- 构造函数
- 箭头函数[生成器函数 generator]
- 基于 call / apply / bind 强制修改 this 指向

```js
// 全局上下文中的this->window
// 块级上下文中没有自己的this，所用的this都是继承上级上下文中的this[箭头函数也是]
console.log(this)
```

## 事件绑定

DOM0：

- `xxx.onxxx=function(){}`

DOM2：

- `xxx.addEventListener('xxx', function(){})`
- `xxx.attachEvent('onxxx', function(){})`

给当前元素的某个事件行为绑定方法[此时是创建方法，方法没执行]，当事件行为触发，浏览器会把绑定的函数执行，此时函数中的 this -> 当前元素对象本身

特殊：基于 attachEvent 实现事件绑定，方法执行，方法中的 this 是 window

```js
document.body.addEventListener('click', function () {
  console.log(this) // body
})
```

## 函数执行

### 普通函数

看函数执行前是否有"点"，有的话"点"前面是谁 this 就是谁，没有 this 是 window[严格模式下是 undefined]

```js
function fn() {
  console.log(this)
}
let obj = {
  name: 'test',
  fn,
}
fn() // this->window/undefined
obj.fn() // this->obj
```

### 匿名函数

函数表达式：等同于普通函数或者事件绑定机制

```js
var fn = function () {
  console.log(this)
}
fn() // this->window
```

自执行函数：this 一般都是 window/undefined

- 创建函数堆内存因为外面没有接受肯定会被释放
- 执行上下文可能不释放

```js
(function (x) {
  console.log(this) // this->window/undefined
})(10)
```

回调函数：this 一般都是 window/undefined

- 如果另外函数执行中，对回调函数的执行做了特殊处理，以自己处理的为主
- 把一个函数作为实参，传递给另外一个执行的函数[在 B 函数执行中，可以把 A 执行]

```js
function fn(callback) {
  callback()
  // callback.call(obj); // 一般情况下，回调函数内部this是window/undefined，但是如果内部进行了修改，那么就指向修改的值
}
fn(function () {
  console.log(this)
})

let arr = [10]
arr.forEach(
  function (item, i) {
    console.log(this) // {xxx: "xxx"} forEach内部做处理了
  },
  { xxx: 'xxx' }
)
```

### 括号表达式

小括号中包含"多项"，这样也只取最后一项，但是 this 受到影响（一般是 window/undefined）

```js
function fn() {
  console.log(this)
}
let obj = {
  name: 'test',
  fn,
}
obj.fn() // this->obj 小括号内只有一项，和没有小括号是一样的
;(10, obj.fn)() // this->window/undefined
```

## 练习

```js
var x = 3
var obj = { x: 5 }
obj.fn = (function () {
  this.x *= ++x // window.x=window.x*(++x) window.x->12
  return function (y) {
    this.x *= ++x + y
    console.log(x)
  }
})() // 先把自执行函数执行，执行的结果赋值给 obj.fn

var fn = obj.fn
obj.fn(6) // obj.x*=(++window.x)+y obj.x->95 window.x->13
fn(4) // window.x*=(++window.x)+y window.x->234
console.log(obj.x, x) // 95 234
```

![](https://gitee.com/lilyn/pic/raw/master/js-img/this练习1.jpg)

